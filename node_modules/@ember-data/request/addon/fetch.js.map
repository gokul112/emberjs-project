{"version":3,"file":"fetch.js","sources":["../src/fetch.ts"],"sourcesContent":["/**\n * A basic Fetch Handler which converts a request into a\n * `fetch` call presuming the response to be `json`.\n *\n * ```ts\n * import Fetch from '@ember-data/request/fetch';\n *\n * manager.use([Fetch]);\n * ```\n *\n * @module @ember-data/request/fetch\n * @main @ember-data/request/fetch\n */\n\nimport { cloneResponseProperties, type Context } from './-private/context';\n\nconst _fetch: typeof fetch =\n  typeof fetch !== 'undefined'\n    ? fetch\n    : typeof FastBoot !== 'undefined'\n    ? (FastBoot.require('node-fetch') as typeof fetch)\n    : ((() => {\n        throw new Error('No Fetch Implementation Found');\n      }) as typeof fetch);\n\n// clones a response in a way that should still\n// allow it to stream\nfunction cloneResponse(response: Response, overrides: Partial<Response>) {\n  const props = cloneResponseProperties(response);\n  return new Response(response.body, Object.assign(props, overrides));\n}\n\nconst MUTATION_OPS = new Set(['updateRecord', 'createRecord', 'deleteRecord']);\n\n/**\n * A basic handler which converts a request into a\n * `fetch` call presuming the response to be `json`.\n *\n * ```ts\n * import Fetch from '@ember-data/request/fetch';\n *\n * manager.use([Fetch]);\n * ```\n *\n * @class Fetch\n * @public\n */\nconst Fetch = {\n  async request(context: Context) {\n    let response = await _fetch(context.request.url!, context.request);\n\n    const isError = !response.ok || response.status >= 400;\n    const op = context.request.op;\n    const isMutationOp = Boolean(op && MUTATION_OPS.has(op));\n\n    if (!isError && !isMutationOp && response.status !== 204 && !response.headers.has('date')) {\n      const headers = new Headers(response.headers);\n      headers.set('date', new Date().toUTCString());\n      response = cloneResponse(response, { headers });\n    }\n\n    context.setResponse(response);\n\n    // if we are an error, we will want to throw\n    if (isError) {\n      const text = await response.text();\n      let errorPayload: object | undefined;\n      try {\n        errorPayload = JSON.parse(text) as object;\n      } catch {\n        // void;\n      }\n      const error: Error & { content: object | undefined } = new Error(\n        `[${response.status}] ${response.statusText} - ${response.url}`\n      ) as Error & { content: object | undefined };\n      error.content = errorPayload;\n      throw error;\n    } else {\n      return response.status === 204 ? null : response.json();\n    }\n  },\n};\n\nexport default Fetch;\n"],"names":["_fetch","fetch","FastBoot","require","Error","cloneResponse","response","overrides","props","cloneResponseProperties","Response","body","Object","assign","MUTATION_OPS","Set","Fetch","request","context","url","isError","ok","status","op","isMutationOp","Boolean","has","headers","Headers","set","Date","toUTCString","setResponse","text","errorPayload","JSON","parse","error","statusText","content","json"],"mappings":"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"}